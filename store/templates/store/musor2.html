# recommender/views.py
from decimal import Decimal

from django.shortcuts import render
from django.db.models import F, Q

from .forms import RecommendationForm
from store.models import (
    cpu as CPU,
    GPU,
    Motherboard,
    RAM,
    Cooler,
    Case,
    PowerSupply,
    Memory,
)

# ----------------------------------------------------------
# 1. «вес» компонентов в зависимости от сценария
# ----------------------------------------------------------
BUDGET_ALLOCATION = {
    "gaming":   dict(cpu=0.25, gpu=0.40),
    "editing":  dict(cpu=0.35, gpu=0.30),
    "work":     dict(cpu=0.40, gpu=0.20),
    "home":     dict(cpu=0.25, gpu=0.20),
}

# ----------------------------------------------------------
# 2. Минимальные рекомендации по объёму RAM / диска
# ----------------------------------------------------------
MIN_RAM_GB = {
    "gaming": 16,
    "editing": 32,
    "work": 32,
    "home": 16,
}
MIN_SSD_GB = 500


# ----------------------------------------------------------
# 3. Вспомогательные фильтры
# ----------------------------------------------------------
def brand_q(brands, field_name="brand"):
    """Возвращает Q-объект с фильтром по списку брендов."""
    if not brands:
        return Q()
    return Q(**{f"{field_name}__in": brands})


# ----------------------------------------------------------
# 4. Основной алгоритм подбора
# ----------------------------------------------------------
def recommend_build(budget: int, purpose: str, preferred_brands_raw: str):
    budget = Decimal(budget)
    purpose = purpose or "home"
    preferred_brands = [b.strip().title() for b in preferred_brands_raw.split(",") if b.strip()]

    # 4.1. Определяем потолки расходов
    alloc = BUDGET_ALLOCATION.get(purpose, BUDGET_ALLOCATION["home"])
    cpu_limit = budget * Decimal(alloc["cpu"])
    gpu_limit = budget * Decimal(alloc["gpu"])

    # 4.2. Кандидаты CPU и GPU
    cpu_qs = (
        CPU.objects.filter(price__lte=cpu_limit)
        .order_by("-benchmark_score", "price")  # лучший индекс / дешевле
    )
    gpu_qs = (
        GPU.objects.filter(price__lte=gpu_limit)
        .order_by("-performance_score", "price")
    )
    if preferred_brands:
        cpu_qs = cpu_qs.filter(brand_q(preferred_brands))
        gpu_qs = gpu_qs.filter(brand_q(preferred_brands))

    # 4.3. Итерируем CPU → к нему подбираем всё остальное
    for cpu in cpu_qs:
        # 4.3.1. Материнка совместимая по сокету + памяти
        mb_qs = (
            Motherboard.objects.filter(socket=cpu.socket, price__lte=budget * Decimal(0.15))
            .order_by("-m2_slots", "price")
        )
        if preferred_brands:
            mb_qs = mb_qs.filter(brand_q(preferred_brands))
        for mb in mb_qs:
            # 4.3.2. GPU (берём первую, раз уж они отсортированы по производительности)
            gpu = gpu_qs.first()
            if not gpu:
                continue

            # 4.3.3. Память (RAM) подходящего типа и объёма
            ram_needed = MIN_RAM_GB[purpose]
            ram = (
                RAM.objects.filter(
                    memory_type=mb.memory_type,
                    memory__gte=ram_needed,
                    price__lte=budget * Decimal(0.12),
                )
                .order_by("price", "-hertz")
                .first()
            )
            if not ram:
                continue

            # 4.3.4. SSD / NVMe
            ssd = (
                Memory.objects.filter(
                    digital_storage__gte=MIN_SSD_GB,
                    price__lte=budget * Decimal(0.10),
                )
                .order_by("price", "-read_speed")
                .first()
            )
            if not ssd:
                continue

            # 4.3.5. Кулер (по сокету, по высоте, по TDP)
            cooler_qs = Cooler.objects.filter(
                socket__icontains=cpu.socket,
                tdp__gte=cpu.tdp or 65,
            ).order_by("price")
            if preferred_brands:
                cooler_qs = cooler_qs.filter(brand_q(preferred_brands))
            cooler = cooler_qs.first()
            if not cooler:
                continue

            # 4.3.6. Корпус, куда всё влезет
            case_qs = Case.objects.filter(
                max_gpu_length_mm__gte=gpu.length_mm,
                max_cooler_height_mm__gte=cooler.height_mm,
                max_psu_length_mm__gte=140,
            ).order_by("price")
            if preferred_brands:
                case_qs = case_qs.filter(brand_q(preferred_brands))
            case = case_qs.first()
            if not case:
                continue

            # 4.3.7. Блок питания с запасом
            total_power = int((cpu.tdp or 65) + gpu.power_draw_w + 100)
            psu_qs = (
                PowerSupply.objects.filter(wattage__gte=total_power * 1.25)
                .order_by("price")
            )
            if preferred_brands:
                psu_qs = psu_qs.filter(brand_q(preferred_brands))
            psu = psu_qs.first()
            if not psu:
                continue

            # 4.3.8. Проверяем, уложились ли в бюджет
            parts = [cpu, gpu, mb, ram, ssd, cooler, case, psu]
            total_price = sum(map(lambda p: p.price, parts))
            if total_price <= budget:
                return dict(
                    cpu=cpu,
                    gpu=gpu,
                    motherboard=mb,
                    ram=ram,
                    storage=ssd,
                    cooler=cooler,
                    case=case,
                    psu=psu,
                    total_price=total_price,
                )

    # не нашли подходящей сборки
    return None


# ----------------------------------------------------------
# 5. Представление (view)
# ----------------------------------------------------------
def recommender_view(request):
    if request.method == "POST":
        form = RecommendationForm(request.POST)
        if form.is_valid():
            build = recommend_build(
                budget=form.cleaned_data["budget"],
                purpose=form.cleaned_data["purpose"],
                preferred_brands_raw=form.cleaned_data["preferred_brands"],
            )
            if build:
                # сохраняем в сессии PK выбранных компонентов
                request.session["last_build"] = {
                    "cpu": build["cpu"].pk,
                    "gpu": build["gpu"].pk,
                    "motherboard": build["motherboard"].pk,
                    "ram": build["ram"].pk,
                    "storage": build["storage"].pk,
                    "cooler": build["cooler"].pk,
                    "case": build["case"].pk,
                    "psu": build["psu"].pk,
                    "total": str(build["total_price"]),
                }
                return redirect("recommender_result")   # ⬅️ редирект
            else:
                messages.warning(
                    request,
                    "Не удалось подобрать сборку: попробуйте увеличить бюджет "
                    "или убрать ограничения по брендам.",
                )
                # падать не будем, покажем форму вновь
    else:
        form = RecommendationForm()

    return render(request, "recommender/recommend.html", {"form": form})


# ------------------------------------------------------------------
# 2. отображаем результат GET‑запросом
# ------------------------------------------------------------------
def recommender_result_view(request):
    build_ids = request.session.get("last_build")
    if not build_ids:
        messages.info(request, "Сначала задайте параметры подбора сборки.")
        return redirect("recommender_view")

    build = {
        "cpu": CPU.objects.get(pk=build_ids["cpu"]),
        "gpu": GPU.objects.get(pk=build_ids["gpu"]),
        "motherboard": Motherboard.objects.get(pk=build_ids["motherboard"]),
        "ram": RAM.objects.get(pk=build_ids["ram"]),
        "storage": Memory.objects.get(pk=build_ids["storage"]),
        "cooler": Cooler.objects.get(pk=build_ids["cooler"]),
        "case": Case.objects.get(pk=build_ids["case"]),
        "psu": PowerSupply.objects.get(pk=build_ids["psu"]),
        "total_price": Decimal(build_ids["total"]),
    }

    form = RecommendationForm()  # показ для «подобрать заново»
    return render(
        request,
        "recommender/recommendation_result.html",
        {"form": form, "build": build},
    )
